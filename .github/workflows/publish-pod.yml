name: Release iOS SDK to CocoaPods

on:
  push:
    branches: [ main ]
    paths:
      - 'NexaGuardSDK.xcframework/**'
      - 'NexaGuardSDK.podspec'

jobs:
  publish:
    runs-on: macos-13   # macOS runner gives you codesign & Xcode CLI

    env:
      POD_TRUNK_TOKEN: ${{ secrets.POD_TRUNK_TOKEN }}   # <â€” add in repo secrets
      GIT_USER_NAME:  NexaGuard-CI
      GIT_USER_EMAIL: ios@nexaguard.com

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # we need history for tags

      - name: Strip _CodeSignature & re-sign
        run: |
          echo "â–¶ï¸Ž Cleaning signatures"
          rm -rf build && mkdir build
          cp -R NexaGuardSDK.xcframework build/
          cd build
          find NexaGuardSDK.xcframework -name _CodeSignature -type d -exec rm -rf {} +
          codesign --force --sign - NexaGuardSDK.xcframework/ios-arm64/*.framework
          codesign --force --sign - NexaGuardSDK.xcframework/ios-arm64_x86_64-simulator/*.framework
          cd ..
          mv build/NexaGuardSDK.xcframework .

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #  bump the version **outside** of any run block
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Auto-bump podspec version
        id: bump
        run: |
          CURRENT=$(grep -E "s.version.*=" NexaGuardSDK.podspec | awk -F"'" '{print $2}')
          LATEST=$(git tag --list --sort=-v:refname | head -n1)

          NEW="$CURRENT"
          if [ "$LATEST" = "$CURRENT" ]; then
            IFS='.' read -r MAJ MIN PAT <<< "$CURRENT"
            NEW="${MAJ}.${MIN}.$((PAT+1))"
            sed -i '' "s/s.version[[:space:]]*=.*/s.version          = '$NEW'/" NexaGuardSDK.podspec
          fi

          echo "Bumping podspec   : $CURRENT â†’ $NEW"
          echo "newver=$NEW" >> "$GITHUB_OUTPUT"

      - name: Commit, tag & push
        run: |
          git config user.name  "$GIT_USER_NAME"
          git config user.email "$GIT_USER_EMAIL"

          git add NexaGuardSDK.xcframework NexaGuardSDK.podspec
          git commit -m "iOS ${{ steps.bump.outputs.newver }} â€“ automated release ðŸš€"

          # create / update the tag, then push
          git tag -f ${{ steps.bump.outputs.newver }}
          git push origin main --tags --force-with-lease

      - name: Publish to CocoaPods Trunk
        run: |
          echo "$POD_TRUNK_TOKEN" | pod trunk register ios@nexaguard.com 'CI Bot' --description='CI' || true
          pod trunk push NexaGuardSDK.podspec --allow-warnings --skip-tests --verbose
